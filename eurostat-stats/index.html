<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-6474686113446159">
    <title>Eurostat Statistics Explorer</title>
    <meta name="description" content="Interactive explorer for European statistics from Eurostat. Search datasets, pick countries, and visualize data with one click.">
    <meta name="keywords" content="Eurostat, European statistics, charts, data visualization, economy, tourism, employment, demographics, environment, Europe, statistics API">
    <!-- Open Graph / Facebook -->
    <meta property="og:title" content="Eurostat Statistics Explorer">
    <meta property="og:description" content="Interactive explorer for European statistics from Eurostat. Search datasets, pick countries, and visualize data with one click.">
    <meta property="og:type" content="website">
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Eurostat Statistics Explorer">
    <meta name="twitter:description" content="Interactive explorer for European statistics from Eurostat. Search datasets, pick countries, and visualize data with one click.">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon/favicon-16x16.png">
    <link rel="manifest" href="../favicon/site.webmanifest">
    <link rel="shortcut icon" href="../favicon/favicon.ico">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-599PBS1V4S"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-599PBS1V4S');
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6474686113446159" crossorigin="anonymous"></script>
</head>
<body>
    <header>
        <h1>Eurostat Statistics Explorer</h1>
        <p class="subtitle">Search any dataset, pick countries, and visualize — no API knowledge needed</p>
        <nav id="mainNav"></nav>
    </header>
    <div class="container-fluid flex-grow-1">
        <div class="row">
            <div class="col-lg-2 d-none d-lg-flex flex-column align-items-center justify-content-start p-0">
                <ins class="adsbygoogle"
                    style="display:block;width:160px;height:600px"
                    data-ad-client="ca-pub-6474686113446159"
                    data-ad-slot="1234567890"></ins>
            </div>
            <main class="col-12 col-lg-8 d-flex flex-column align-items-center py-3">

                <!-- Explorer Section -->
                <section class="card w-100 my-2 explorer-card">
                    <div class="card-body">
                        <h2>Explore a Dataset</h2>
                        <p class="text-muted mb-3">Pick a dataset, select countries, and click <strong>Visualize</strong>.</p>

                        <!-- Dataset Search -->
                        <div class="explorer-field">
                            <label for="datasetSearch">Dataset</label>
                            <input type="text" id="datasetSearch" class="form-control" placeholder="Search datasets (e.g. GDP, unemployment, tourism)..." autocomplete="off">
                            <div id="datasetDropdown" class="explorer-dropdown"></div>
                            <div id="selectedDataset" class="selected-dataset-badge" style="display:none;"></div>
                        </div>

                        <!-- Country Selector -->
                        <div class="explorer-field">
                            <label>Countries</label>
                            <div class="country-presets">
                                <button class="btn-preset active" data-preset="default">DE, EL, FR, IT</button>
                                <button class="btn-preset" data-preset="EU Big 4">EU Big 4</button>
                                <button class="btn-preset" data-preset="Southern Europe">Southern</button>
                                <button class="btn-preset" data-preset="Nordic">Nordic</button>
                                <button class="btn-preset" data-preset="Central Europe">Central</button>
                                <button class="btn-preset" data-preset="custom">Custom...</button>
                            </div>
                            <div id="customCountryPicker" class="country-picker" style="display:none;"></div>
                        </div>

                        <!-- Chart Type -->
                        <div class="explorer-field">
                            <label for="chartTypeSelect">Chart type</label>
                            <select id="chartTypeSelect" class="form-select form-select-sm" style="max-width:200px;">
                                <option value="line" selected>Line</option>
                                <option value="bar">Bar</option>
                                <option value="stacked-area">Stacked Area</option>
                            </select>
                        </div>

                        <!-- Visualize Button -->
                        <button id="visualizeBtn" class="btn-visualize" disabled>Visualize</button>

                        <!-- Advanced: raw URL toggle -->
                        <details class="mt-3">
                            <summary class="text-muted" style="cursor:pointer; font-size:0.85rem;">Advanced: paste raw API URL</summary>
                            <div class="input-group mt-2">
                                <input type="text" id="rawUrlInput" class="form-control" placeholder="https://ec.europa.eu/eurostat/api/dissemination/statistics/1.0/data/...">
                                <button class="btn-fetch" type="button" id="rawFetchBtn">Fetch</button>
                            </div>
                        </details>
                    </div>
                </section>

                <!-- Result Chart -->
                <section id="resultSection" class="card w-100 my-2 chart-section" style="display:none;">
                    <div class="card-body">
                        <div class="chart-header">
                            <h2 class="chart-title" id="resultTitle"></h2>
                            <div class="chart-actions">
                                <button class="btn-action" id="resultTableToggle">Table</button>
                                <button class="btn-action" id="resultCsvBtn">CSV</button>
                                <button class="btn-action" id="resultPngBtn">PNG</button>
                                <button class="btn-action" id="resultShareBtn">Share</button>
                            </div>
                        </div>
                        <p class="chart-desc" id="resultDesc"></p>
                        <div class="chart-updated text-muted" id="resultUpdated"></div>
                        <div style="position:relative;">
                            <div class="loading-overlay" id="resultLoading">
                                <div class="loading-spinner"></div>
                            </div>
                            <canvas id="resultChart" width="400" height="200"></canvas>
                        </div>
                        <div class="data-table-wrapper" id="resultTable" style="display:none;"></div>
                    </div>
                </section>

                <!-- Dataset Catalog (searchable) -->
                <section class="card w-100 my-2">
                    <div class="card-body">
                        <h2>Dataset Catalog</h2>
                        <p class="text-muted mb-3">Browse all available datasets by category. Click any dataset to load it in the Explorer above.</p>
                        <div id="datasetCatalog"></div>
                        <p class="text-muted mt-2 mb-0" style="font-size:0.85rem;">For the full catalog, visit the <a href="https://ec.europa.eu/eurostat/data/database" target="_blank">Eurostat Database</a>.</p>
                    </div>
                </section>

            </main>
            <div class="col-lg-2 d-none d-lg-flex flex-column align-items-center justify-content-start p-0">
                <ins class="adsbygoogle"
                    style="display:block;width:160px;height:600px"
                    data-ad-client="ca-pub-6474686113446159"
                    data-ad-slot="1234567890"></ins>
            </div>
        </div>
    </div>
    <footer>
        <div class="container">
            Data provided by <a href="https://ec.europa.eu/eurostat" target="_blank">Eurostat</a> &mdash;
            <a href="https://ec.europa.eu/eurostat/web/user-guides/data-browser/api-data-access/api-getting-started" target="_blank">API Documentation</a>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/config.js"></script>
    <script src="js/cache.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ── Explorer State ───────────────────────────────────
        var explorerState = {
            datasetCode: null,
            geo: CONFIG.defaultGeo.slice(),
            chartType: 'line',
            chartInstance: null,
            chartData: null,
            lastUrl: null,
        };

        // ── Nav ──────────────────────────────────────────────
        document.getElementById('mainNav').innerHTML = UI.navHTML('index');

        // ── Dataset Search & Dropdown ────────────────────────
        var searchInput = document.getElementById('datasetSearch');
        var dropdown = document.getElementById('datasetDropdown');
        var selectedBadge = document.getElementById('selectedDataset');

        function renderDropdown(results) {
            if (!results.length) {
                dropdown.innerHTML = '<div class="dropdown-empty">No datasets found.</div>';
                dropdown.style.display = 'block';
                return;
            }
            var html = '';
            for (var i = 0; i < results.length; i++) {
                var r = results[i];
                html += '<div class="dropdown-item" data-code="' + r.code + '">' +
                    '<span class="dropdown-code">' + r.code + '</span>' +
                    '<span class="dropdown-name">' + UI._esc(r.name) + '</span>' +
                    '<span class="dropdown-cat">' + UI._esc(r.category) + '</span>' +
                '</div>';
            }
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }

        searchInput.addEventListener('input', function () {
            var q = this.value.trim();
            if (q.length < 1) { dropdown.style.display = 'none'; return; }
            renderDropdown(searchDatasets(q));
        });

        searchInput.addEventListener('focus', function () {
            if (this.value.trim().length >= 1) {
                renderDropdown(searchDatasets(this.value.trim()));
            }
        });

        dropdown.addEventListener('click', function (e) {
            var item = e.target.closest('.dropdown-item');
            if (!item) return;
            selectDataset(item.dataset.code);
        });

        document.addEventListener('click', function (e) {
            if (!e.target.closest('#datasetSearch') && !e.target.closest('#datasetDropdown')) {
                dropdown.style.display = 'none';
            }
        });

        function selectDataset(code) {
            explorerState.datasetCode = code;
            var meta = DATASETS[code];
            searchInput.value = '';
            dropdown.style.display = 'none';
            selectedBadge.style.display = 'flex';
            selectedBadge.innerHTML =
                '<span><code>' + code + '</code> — ' + UI._esc(meta ? meta.name : code) + '</span>' +
                '<button class="badge-remove" title="Clear">&times;</button>';
            document.getElementById('visualizeBtn').disabled = false;
        }

        selectedBadge.addEventListener('click', function (e) {
            if (e.target.classList.contains('badge-remove')) {
                explorerState.datasetCode = null;
                selectedBadge.style.display = 'none';
                document.getElementById('visualizeBtn').disabled = true;
            }
        });

        // ── Country Presets ──────────────────────────────────
        var presetBtns = document.querySelectorAll('.btn-preset');
        var customPicker = document.getElementById('customCountryPicker');

        function setActivePreset(btn) {
            presetBtns.forEach(function (b) { b.classList.remove('active'); });
            btn.classList.add('active');
        }

        // Build custom country picker checkboxes
        (function buildCountryPicker() {
            var html = '';
            var codes = Object.keys(CONFIG.countries).sort(function (a, b) {
                return CONFIG.countries[a].localeCompare(CONFIG.countries[b]);
            });
            for (var i = 0; i < codes.length; i++) {
                var c = codes[i];
                var checked = CONFIG.defaultGeo.indexOf(c) !== -1 ? ' checked' : '';
                html += '<label class="country-chip">' +
                    '<input type="checkbox" value="' + c + '"' + checked + '>' +
                    '<span>' + c + '</span>' +
                '</label>';
            }
            customPicker.innerHTML = html;
        })();

        document.addEventListener('click', function (e) {
            var btn = e.target.closest('.btn-preset');
            if (!btn) return;
            setActivePreset(btn);
            var preset = btn.dataset.preset;
            if (preset === 'custom') {
                customPicker.style.display = 'flex';
                updateGeoFromCustom();
            } else {
                customPicker.style.display = 'none';
                if (preset === 'default') {
                    explorerState.geo = CONFIG.defaultGeo.slice();
                } else if (CONFIG.countryPresets[preset]) {
                    explorerState.geo = CONFIG.countryPresets[preset].slice();
                }
            }
        });

        customPicker.addEventListener('change', function () {
            updateGeoFromCustom();
        });

        function updateGeoFromCustom() {
            var checked = customPicker.querySelectorAll('input:checked');
            explorerState.geo = Array.from(checked).map(function (cb) { return cb.value; });
        }

        // ── Chart Type ───────────────────────────────────────
        document.getElementById('chartTypeSelect').addEventListener('change', function () {
            explorerState.chartType = this.value;
        });

        // ── Visualize ────────────────────────────────────────
        document.getElementById('visualizeBtn').addEventListener('click', async function () {
            if (!explorerState.datasetCode) return;
            var meta = DATASETS[explorerState.datasetCode];
            var filters = meta ? meta.defaultFilters : {};
            var url = buildEurostatUrl(explorerState.datasetCode, explorerState.geo, filters);
            await doVisualize(url, explorerState.chartType);
        });

        // ── Raw URL Fetch ────────────────────────────────────
        document.getElementById('rawFetchBtn').addEventListener('click', async function () {
            var url = document.getElementById('rawUrlInput').value.trim();
            if (!url) return;
            await doVisualize(url, explorerState.chartType);
        });

        document.getElementById('rawUrlInput').addEventListener('keydown', async function (e) {
            if (e.key === 'Enter') {
                var url = this.value.trim();
                if (url) await doVisualize(url, explorerState.chartType);
            }
        });

        // ── Shared Visualization Logic ───────────────────────
        async function doVisualize(url, chartType) {
            var resultSection = document.getElementById('resultSection');
            var loading = document.getElementById('resultLoading');
            var titleEl = document.getElementById('resultTitle');
            var descEl = document.getElementById('resultDesc');
            var updatedEl = document.getElementById('resultUpdated');

            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            loading.classList.add('active');
            explorerState.lastUrl = url;

            try {
                var data = await fetchEurostatData(url);
                if (data) {
                    explorerState.chartInstance = renderEurostatChart(
                        data, 'resultChart', explorerState.chartInstance, { chartType: chartType }
                    );
                    explorerState.chartData = data;
                    titleEl.textContent = data.label || 'Chart';

                    // Description from config if available
                    if (explorerState.datasetCode && DATASETS[explorerState.datasetCode]) {
                        descEl.textContent = DATASETS[explorerState.datasetCode].description;
                    } else {
                        descEl.textContent = '';
                    }

                    var updateText = data.updated ? 'Data updated: ' + data.updated : '';
                    if (data._fromCache) updateText += ' (cached)';
                    updatedEl.textContent = updateText;
                }
            } finally {
                loading.classList.remove('active');
            }
        }

        // ── Result Actions ───────────────────────────────────
        document.getElementById('resultTableToggle').addEventListener('click', function () {
            var tableEl = document.getElementById('resultTable');
            if (tableEl.style.display === 'none') {
                tableEl.style.display = 'block';
                tableEl.innerHTML = UI.dataTableHTML(explorerState.chartData);
                this.textContent = 'Chart';
            } else {
                tableEl.style.display = 'none';
                this.textContent = 'Table';
            }
        });

        document.getElementById('resultCsvBtn').addEventListener('click', function () {
            if (explorerState.chartData) UI.downloadCSV(explorerState.chartData, 'eurostat_explorer');
            else UI.toast('No data loaded yet.', 'warning');
        });

        document.getElementById('resultPngBtn').addEventListener('click', function () {
            if (explorerState.chartInstance) UI.downloadPNG(explorerState.chartInstance, 'eurostat_chart');
            else UI.toast('No chart rendered yet.', 'warning');
        });

        document.getElementById('resultShareBtn').addEventListener('click', function () {
            if (explorerState.lastUrl) UI.copyShareUrl(explorerState.lastUrl);
        });

        // ── Dataset Catalog ──────────────────────────────────
        (function renderCatalog() {
            var groups = getDatasetsByCategory();
            var catalogEl = document.getElementById('datasetCatalog');
            var html = '';
            var cats = Object.keys(groups).sort();
            for (var ci = 0; ci < cats.length; ci++) {
                var cat = cats[ci];
                var datasets = groups[cat];
                html += '<div class="dataset-codes-section mb-3">' +
                    '<button class="dataset-codes-toggle" aria-expanded="false">' +
                        '<span>' + UI._esc(cat) + ' <span class="dataset-codes-count">(' + datasets.length + ')</span></span>' +
                        '<span class="toggle-icon">&#9660;</span>' +
                    '</button>' +
                    '<div class="dataset-codes-list">';
                for (var di = 0; di < datasets.length; di++) {
                    var d = datasets[di];
                    html += '<div class="code-item" data-code="' + d.code + '" style="cursor:pointer;" title="Click to load in Explorer">' +
                        '<code>' + d.code + '</code>' +
                        '<span class="code-desc">' + UI._esc(d.name) + '</span>' +
                    '</div>';
                }
                html += '</div></div>';
            }
            catalogEl.innerHTML = html;

            // Toggle expand/collapse
            catalogEl.addEventListener('click', function (e) {
                var toggle = e.target.closest('.dataset-codes-toggle');
                if (toggle) {
                    var expanded = toggle.getAttribute('aria-expanded') === 'true';
                    toggle.setAttribute('aria-expanded', !expanded);
                    toggle.nextElementSibling.classList.toggle('expanded');
                    return;
                }
                // Click on a dataset code to load it
                var codeItem = e.target.closest('.code-item');
                if (codeItem && codeItem.dataset.code) {
                    selectDataset(codeItem.dataset.code);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
        })();

        // ── Handle share URL on page load ────────────────────
        (function handleShareUrl() {
            var params = new URLSearchParams(window.location.search);
            var sharedUrl = params.get('url');
            if (sharedUrl) {
                document.getElementById('rawUrlInput').value = sharedUrl;
                doVisualize(sharedUrl, explorerState.chartType);
            }
        })();

        try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch(e) {}
        try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch(e) {}
    </script>
</body>
</html>
