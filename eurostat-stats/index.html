<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-adsense-account" content="ca-pub-6474686113446159">
    <title>Eurostat Statistics Explorer</title>
    <meta name="description" content="Interactive explorer for European statistics from Eurostat. Search datasets, pick countries, and visualize data with one click.">
    <meta name="keywords" content="Eurostat, European statistics, charts, data visualization, economy, tourism, employment, demographics, environment, Europe, statistics API">
    <!-- Open Graph / Facebook -->
    <meta property="og:title" content="Eurostat Statistics Explorer">
    <meta property="og:description" content="Interactive explorer for European statistics from Eurostat. Search datasets, pick countries, and visualize data with one click.">
    <meta property="og:type" content="website">
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Eurostat Statistics Explorer">
    <meta name="twitter:description" content="Interactive explorer for European statistics from Eurostat. Search datasets, pick countries, and visualize data with one click.">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon/favicon-16x16.png">
    <link rel="manifest" href="../favicon/site.webmanifest">
    <link rel="shortcut icon" href="../favicon/favicon.ico">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-599PBS1V4S"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-599PBS1V4S');
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6474686113446159" crossorigin="anonymous"></script>
</head>
<body>
    <header>
        <h1>Eurostat Statistics Explorer</h1>
        <p class="subtitle">Search any dataset, pick countries, and visualize — no API knowledge needed</p>
        <nav id="mainNav"></nav>
    </header>
    <div class="container-fluid flex-grow-1">
        <div class="row">
            <div class="col-lg-2 d-none d-lg-flex flex-column align-items-center justify-content-start p-0">
                <ins class="adsbygoogle"
                    style="display:block;width:160px;height:600px"
                    data-ad-client="ca-pub-6474686113446159"
                    data-ad-slot="1234567890"></ins>
            </div>
            <main class="col-12 col-lg-8 d-flex flex-column align-items-center py-3">

                <!-- Explorer Section -->
                <section class="card w-100 my-2 explorer-card">
                    <div class="card-body">
                        <h2>Explore a Dataset</h2>
                        <p class="text-muted mb-3">Pick a dataset, select countries, and click <strong>Visualize</strong>.</p>

                        <!-- Dataset Search -->
                        <div class="explorer-field">
                            <label for="datasetSearch">Dataset</label>
                            <input type="text" id="datasetSearch" class="form-control" placeholder="Search datasets (e.g. GDP, unemployment, tourism)..." autocomplete="off">
                            <div id="datasetDropdown" class="explorer-dropdown"></div>
                            <div id="selectedDataset" class="selected-dataset-badge" style="display:none;"></div>
                        </div>

                        <!-- Country Selector -->
                        <div class="explorer-field">
                            <label>Countries</label>
                            <div class="country-presets">
                                <button class="btn-preset active" data-preset="default">DE, EL, FR, IT</button>
                                <button class="btn-preset" data-preset="EU Big 4">EU Big 4</button>
                                <button class="btn-preset" data-preset="Southern Europe">Southern</button>
                                <button class="btn-preset" data-preset="Nordic">Nordic</button>
                                <button class="btn-preset" data-preset="Central Europe">Central</button>
                                <button class="btn-preset" data-preset="custom">Custom...</button>
                            </div>
                            <div id="customCountryPicker" class="country-picker" style="display:none;"></div>
                        </div>

                        <!-- Chart Type -->
                        <div class="explorer-field">
                            <label for="chartTypeSelect">Chart type</label>
                            <select id="chartTypeSelect" class="form-select form-select-sm" style="max-width:200px;">
                                <option value="line" selected>Line</option>
                                <option value="bar">Bar</option>
                                <option value="stacked-area">Stacked Area</option>
                            </select>
                        </div>

                        <!-- Event Overlay Packs -->
                        <div class="explorer-field">
                            <label>Event overlays</label>
                            <div id="eventPackControls" class="event-pack-controls"></div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="majorEventsOnly" checked>
                                <label class="form-check-label" for="majorEventsOnly">Only major events</label>
                            </div>
                        </div>

                        <!-- Visualize Button -->
                        <button id="visualizeBtn" class="btn-visualize" disabled>Visualize</button>

                        <!-- Advanced: raw URL toggle -->
                        <details class="mt-3">
                            <summary class="text-muted" style="cursor:pointer; font-size:0.85rem;">Advanced: paste raw API URL</summary>
                            <div class="input-group mt-2">
                                <input type="text" id="rawUrlInput" class="form-control" placeholder="https://ec.europa.eu/eurostat/api/dissemination/statistics/1.0/data/...">
                                <button class="btn-fetch" type="button" id="rawFetchBtn">Fetch</button>
                            </div>
                        </details>
                    </div>
                </section>

                <!-- Result Chart -->
                <section id="resultSection" class="card w-100 my-2 chart-section" style="display:none;">
                    <div class="card-body">
                        <div class="chart-header">
                            <h2 class="chart-title" id="resultTitle"></h2>
                            <div class="chart-actions">
                                <button class="btn-action" id="resultTableToggle">Table</button>
                                <button class="btn-action" id="resultCsvBtn">CSV</button>
                                <button class="btn-action" id="resultPngBtn">PNG</button>
                                <button class="btn-action" id="resultCardBtn" title="Create shareable card">Card</button>
                                <button class="btn-action" id="resultShareBtn">Share</button>
                                <button class="btn-action" id="resultExplainBtn">Explain</button>
                                <button class="btn-action" id="resultPinBtn">Pin</button>
                            </div>
                        </div>
                        <p class="chart-desc" id="resultDesc"></p>
                        <div class="chart-updated text-muted" id="resultUpdated"></div>
                        <div style="position:relative;">
                            <div class="loading-overlay" id="resultLoading">
                                <div class="loading-spinner"></div>
                            </div>
                            <canvas id="resultChart" width="400" height="200"></canvas>
                        </div>
                        <div class="data-table-wrapper" id="resultTable" style="display:none;"></div>
                        <div class="chart-explain" id="resultExplain" style="display:none;"></div>
                    </div>
                </section>

                <section class="card w-100 my-2">
                    <div class="card-body">
                        <h2>Signal Feed</h2>
                        <p class="text-muted mb-2">Notable year-on-year changes from your latest visualization.</p>
                        <div id="signalFeedContainer"></div>
                    </div>
                </section>

                <section class="card w-100 my-2">
                    <div class="card-body">
                        <h2>My Dashboard</h2>
                        <p class="text-muted mb-2">Pin charts and reopen them instantly. Stored locally in your browser.</p>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button class="btn-action" id="dashboardExportBtn">Export JSON</button>
                            <button class="btn-action" id="dashboardImportBtn">Import JSON</button>
                            <input type="file" id="dashboardImportInput" accept="application/json" style="display:none;">
                        </div>
                        <div id="myDashboardList"></div>
                    </div>
                </section>

                <!-- Dataset Catalog (searchable) -->
                <section class="card w-100 my-2">
                    <div class="card-body">
                        <h2>Dataset Catalog</h2>
                        <p class="text-muted mb-3">Browse all available datasets by category. Click any dataset to load it in the Explorer above.</p>
                        <div id="datasetCatalog"></div>
                        <p class="text-muted mt-2 mb-0" style="font-size:0.85rem;">For the full catalog, visit the <a href="https://ec.europa.eu/eurostat/data/database" target="_blank">Eurostat Database</a>.</p>
                    </div>
                </section>

            </main>
            <div class="col-lg-2 d-none d-lg-flex flex-column align-items-center justify-content-start p-0">
                <ins class="adsbygoogle"
                    style="display:block;width:160px;height:600px"
                    data-ad-client="ca-pub-6474686113446159"
                    data-ad-slot="1234567890"></ins>
            </div>
        </div>
    </div>
    <footer>
        <div class="container">
            Data provided by <a href="https://ec.europa.eu/eurostat" target="_blank">Eurostat</a> &mdash;
            <a href="https://ec.europa.eu/eurostat/web/user-guides/data-browser/api-data-access/api-getting-started" target="_blank">API Documentation</a>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/cache.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ── Explorer State ───────────────────────────────────
        var explorerState = {
            datasetCode: null,
            geo: CONFIG.defaultGeo.slice(),
            chartType: 'line',
            timelinePacks: ['macro'],
            majorEventsOnly: true,
            chartInstance: null,
            chartData: null,
            lastUrl: null,
            signalItems: [],
        };

        // ── Nav ──────────────────────────────────────────────
        document.getElementById('mainNav').innerHTML = UI.navHTML('index');
        var signalFeedContainer = document.getElementById('signalFeedContainer');
        var myDashboardList = document.getElementById('myDashboardList');

        // ── Dataset Search & Dropdown ────────────────────────
        var searchInput = document.getElementById('datasetSearch');
        var dropdown = document.getElementById('datasetDropdown');
        var selectedBadge = document.getElementById('selectedDataset');

        function renderDropdown(results) {
            if (!results.length) {
                dropdown.innerHTML = '<div class="dropdown-empty">No datasets found.</div>';
                dropdown.style.display = 'block';
                return;
            }
            var html = '';
            for (var i = 0; i < results.length; i++) {
                var r = results[i];
                html += '<div class="dropdown-item" data-code="' + r.code + '">' +
                    '<span class="dropdown-code">' + r.code + '</span>' +
                    '<span class="dropdown-name">' + UI._esc(r.name) + '</span>' +
                    '<span class="dropdown-cat">' + UI._esc(r.category) + '</span>' +
                '</div>';
            }
            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }

        searchInput.addEventListener('input', function () {
            var q = this.value.trim();
            if (q.length < 1) { dropdown.style.display = 'none'; return; }
            renderDropdown(searchDatasets(q));
        });

        searchInput.addEventListener('focus', function () {
            if (this.value.trim().length >= 1) {
                renderDropdown(searchDatasets(this.value.trim()));
            }
        });

        dropdown.addEventListener('click', function (e) {
            var item = e.target.closest('.dropdown-item');
            if (!item) return;
            selectDataset(item.dataset.code);
        });

        document.addEventListener('click', function (e) {
            if (!e.target.closest('#datasetSearch') && !e.target.closest('#datasetDropdown')) {
                dropdown.style.display = 'none';
            }
        });

        function selectDataset(code) {
            explorerState.datasetCode = code;
            var meta = DATASETS[code];
            searchInput.value = '';
            dropdown.style.display = 'none';
            selectedBadge.style.display = 'flex';
            selectedBadge.innerHTML =
                '<span><code>' + code + '</code> — ' + UI._esc(meta ? meta.name : code) + '</span>' +
                '<button class="badge-remove" title="Clear">&times;</button>';
            document.getElementById('visualizeBtn').disabled = false;
        }

        selectedBadge.addEventListener('click', function (e) {
            if (e.target.classList.contains('badge-remove')) {
                explorerState.datasetCode = null;
                selectedBadge.style.display = 'none';
                document.getElementById('visualizeBtn').disabled = true;
                window.history.replaceState({}, '', window.location.pathname);
            }
        });

        // ── Country Presets ──────────────────────────────────
        var presetBtns = document.querySelectorAll('.btn-preset');
        var customPicker = document.getElementById('customCountryPicker');

        function setActivePreset(btn) {
            presetBtns.forEach(function (b) { b.classList.remove('active'); });
            btn.classList.add('active');
        }

        // Build custom country picker checkboxes
        (function buildCountryPicker() {
            var html = '';
            var codes = Object.keys(CONFIG.countries).sort(function (a, b) {
                return CONFIG.countries[a].localeCompare(CONFIG.countries[b]);
            });
            for (var i = 0; i < codes.length; i++) {
                var c = codes[i];
                var checked = CONFIG.defaultGeo.indexOf(c) !== -1 ? ' checked' : '';
                html += '<label class="country-chip">' +
                    '<input type="checkbox" value="' + c + '"' + checked + '>' +
                    '<span>' + c + '</span>' +
                '</label>';
            }
            customPicker.innerHTML = html;
        })();

        document.addEventListener('click', function (e) {
            var btn = e.target.closest('.btn-preset');
            if (!btn) return;
            setActivePreset(btn);
            var preset = btn.dataset.preset;
            if (preset === 'custom') {
                customPicker.style.display = 'flex';
                updateGeoFromCustom();
            } else {
                customPicker.style.display = 'none';
                if (preset === 'default') {
                    explorerState.geo = CONFIG.defaultGeo.slice();
                } else if (CONFIG.countryPresets[preset]) {
                    explorerState.geo = CONFIG.countryPresets[preset].slice();
                }
            }
        });

        customPicker.addEventListener('change', function () {
            updateGeoFromCustom();
        });

        function updateGeoFromCustom() {
            var checked = customPicker.querySelectorAll('input:checked');
            explorerState.geo = Array.from(checked).map(function (cb) { return cb.value; });
        }

        function parseGeoParam(rawGeo) {
            if (!rawGeo) return [];
            return rawGeo
                .split(',')
                .map(function (g) { return g.trim().toUpperCase(); })
                .filter(function (g) { return !!g; });
        }

        function syncCountryPickerFromState() {
            var inputs = customPicker.querySelectorAll('input[type="checkbox"]');
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].checked = explorerState.geo.indexOf(inputs[i].value) !== -1;
            }
        }

        function parseListParam(raw) {
            if (!raw) return [];
            return raw
                .split(',')
                .map(function (item) { return item.trim(); })
                .filter(function (item) { return !!item; });
        }

        function getTimelineOptions() {
            return {
                packs: explorerState.timelinePacks.slice(),
                majorOnly: explorerState.majorEventsOnly,
                countryCode: explorerState.geo.length ? explorerState.geo[0] : '',
            };
        }

        function renderEventPackControls() {
            var host = document.getElementById('eventPackControls');
            var packs = CONFIG.eventOverlayPacks || {};
            var keys = Object.keys(packs);
            var html = '';
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                var checked = explorerState.timelinePacks.indexOf(key) !== -1 ? ' checked' : '';
                html += '<div class="form-check form-check-inline">' +
                    '<input class="form-check-input event-pack-input" type="checkbox" id="eventPack_' + key + '" value="' + key + '"' + checked + '>' +
                    '<label class="form-check-label" for="eventPack_' + key + '">' + UI._esc(packs[key].label || key) + '</label>' +
                '</div>';
            }
            host.innerHTML = html;
            document.getElementById('majorEventsOnly').checked = explorerState.majorEventsOnly;
        }

        function syncTimelineFromControls() {
            var checked = document.querySelectorAll('.event-pack-input:checked');
            explorerState.timelinePacks = Array.from(checked).map(function (el) { return el.value; });
            if (!explorerState.timelinePacks.length) {
                explorerState.timelinePacks = ['macro'];
                renderEventPackControls();
            }
            explorerState.majorEventsOnly = !!document.getElementById('majorEventsOnly').checked;
            if (explorerState.chartData) {
                explorerState.chartInstance = renderEurostatChart(
                    explorerState.chartData,
                    'resultChart',
                    explorerState.chartInstance,
                    {
                        chartType: explorerState.chartType,
                        chartTitle: document.getElementById('resultTitle').textContent,
                        timelineOptions: getTimelineOptions(),
                    }
                );
            }
            if (explorerState.datasetCode) updateExplorerUrlState();
        }

        function renderSignalFeed() {
            signalFeedContainer.innerHTML = UI.signalFeedHTML(
                explorerState.signalItems,
                'No notable year-on-year shifts yet. Visualize a dataset to populate the feed.'
            );
        }

        function getDashboardStorageKey() {
            return (CONFIG.myDashboard && CONFIG.myDashboard.storageKey) ? CONFIG.myDashboard.storageKey : 'eurostat_my_dashboard_v1';
        }

        function loadDashboardState() {
            try {
                var raw = localStorage.getItem(getDashboardStorageKey());
                if (!raw) return { pinned: [], defaultViewId: null };
                var parsed = JSON.parse(raw);
                if (!Array.isArray(parsed.pinned)) parsed.pinned = [];
                return parsed;
            } catch (err) {
                return { pinned: [], defaultViewId: null };
            }
        }

        function saveDashboardState(state) {
            localStorage.setItem(getDashboardStorageKey(), JSON.stringify(state));
        }

        function applyPinnedView(item) {
            if (!item || !item.dataset) return;
            explorerState.geo = Array.isArray(item.geo) && item.geo.length ? item.geo.slice() : CONFIG.defaultGeo.slice();
            explorerState.chartType = item.type || 'line';
            explorerState.timelinePacks = Array.isArray(item.events) && item.events.length ? item.events.slice() : ['macro'];
            explorerState.majorEventsOnly = item.majorOnly !== false;
            document.getElementById('chartTypeSelect').value = explorerState.chartType;
            syncCountryPickerFromState();
            var customBtn = document.querySelector('.btn-preset[data-preset="custom"]');
            if (customBtn) {
                setActivePreset(customBtn);
                customPicker.style.display = 'flex';
            }
            renderEventPackControls();
            selectDataset(item.dataset);
            var meta = DATASETS[item.dataset];
            var filters = meta ? meta.defaultFilters : {};
            var url = buildEurostatUrl(item.dataset, explorerState.geo, filters);
            doVisualize(url, explorerState.chartType);
        }

        function renderMyDashboard() {
            var state = loadDashboardState();
            if (!state.pinned.length) {
                myDashboardList.innerHTML = '<p class="text-muted mb-0">No pinned charts yet. Use <strong>Pin</strong> after visualizing a chart.</p>';
                return;
            }
            var html = '<div class="my-dashboard-list">';
            for (var i = 0; i < state.pinned.length; i++) {
                var item = state.pinned[i];
                var title = (DATASETS[item.dataset] && DATASETS[item.dataset].name) ? DATASETS[item.dataset].name : item.dataset;
                var isDefault = state.defaultViewId && state.defaultViewId === item.id;
                html += '<div class="my-dashboard-item">' +
                    '<div>' +
                        '<div><strong>' + UI._esc(title) + '</strong></div>' +
                        '<div class="my-dashboard-meta">' + UI._esc(item.dataset + ' • ' + (item.geo || []).join(', ') + ' • ' + (item.type || 'line')) + '</div>' +
                    '</div>' +
                    '<div class="d-flex gap-1">' +
                        '<button class="btn-action dashboard-load" data-id="' + item.id + '">Load</button>' +
                        '<button class="btn-action dashboard-default" data-id="' + item.id + '">' + (isDefault ? 'Default ✓' : 'Set default') + '</button>' +
                        '<button class="btn-action dashboard-remove" data-id="' + item.id + '">Remove</button>' +
                    '</div>' +
                '</div>';
            }
            html += '</div>';
            myDashboardList.innerHTML = html;
        }

        // ── Chart Type ───────────────────────────────────────
        document.getElementById('chartTypeSelect').addEventListener('change', function () {
            explorerState.chartType = this.value;
            if (explorerState.chartData) {
                explorerState.chartInstance = renderEurostatChart(
                    explorerState.chartData,
                    'resultChart',
                    explorerState.chartInstance,
                    {
                        chartType: explorerState.chartType,
                        chartTitle: document.getElementById('resultTitle').textContent,
                        timelineOptions: getTimelineOptions(),
                    }
                );
            }
            if (explorerState.datasetCode) updateExplorerUrlState();
        });

        document.getElementById('eventPackControls').addEventListener('change', syncTimelineFromControls);
        document.getElementById('majorEventsOnly').addEventListener('change', syncTimelineFromControls);

        function updateExplorerUrlState() {
            if (!explorerState.datasetCode) return;
            var params = new URLSearchParams();
            params.set('dataset', explorerState.datasetCode);
            if (explorerState.geo.length) {
                params.set('geo', explorerState.geo.join(','));
            }
            params.set('type', explorerState.chartType);
            if (explorerState.timelinePacks.length) {
                params.set('events', explorerState.timelinePacks.join(','));
            }
            if (!explorerState.majorEventsOnly) {
                params.set('major', '0');
            }
            window.history.replaceState({}, '', window.location.pathname + '?' + params.toString());
        }

        // ── Visualize ────────────────────────────────────────
        document.getElementById('visualizeBtn').addEventListener('click', async function () {
            if (!explorerState.datasetCode) return;
            var meta = DATASETS[explorerState.datasetCode];
            var filters = meta ? meta.defaultFilters : {};
            var url = buildEurostatUrl(explorerState.datasetCode, explorerState.geo, filters);
            await doVisualize(url, explorerState.chartType);
        });

        // ── Raw URL Fetch ────────────────────────────────────
        document.getElementById('rawFetchBtn').addEventListener('click', async function () {
            var url = document.getElementById('rawUrlInput').value.trim();
            if (!url) return;
            await doVisualize(url, explorerState.chartType);
        });

        document.getElementById('rawUrlInput').addEventListener('keydown', async function (e) {
            if (e.key === 'Enter') {
                var url = this.value.trim();
                if (url) await doVisualize(url, explorerState.chartType);
            }
        });

        // ── Shared Visualization Logic ───────────────────────
        async function doVisualize(url, chartType) {
            var resultSection = document.getElementById('resultSection');
            var loading = document.getElementById('resultLoading');
            var titleEl = document.getElementById('resultTitle');
            var descEl = document.getElementById('resultDesc');
            var updatedEl = document.getElementById('resultUpdated');

            resultSection.style.display = 'block';
            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            loading.classList.add('active');
            explorerState.lastUrl = url;

            try {
                var data = await fetchEurostatData(url);
                if (data) {
                    var configuredTitle = (explorerState.datasetCode && DATASETS[explorerState.datasetCode])
                        ? DATASETS[explorerState.datasetCode].name
                        : '';
                    explorerState.chartInstance = renderEurostatChart(
                        data,
                        'resultChart',
                        explorerState.chartInstance,
                        {
                            chartType: chartType,
                            chartTitle: configuredTitle || data.preferredLabel || data.label,
                            timelineOptions: getTimelineOptions(),
                        }
                    );
                    explorerState.chartData = data;
                    titleEl.textContent = configuredTitle || data.preferredLabel || data.label || 'Chart';

                    // Description from config if available
                    if (explorerState.datasetCode && DATASETS[explorerState.datasetCode]) {
                        descEl.textContent = DATASETS[explorerState.datasetCode].description;
                    } else {
                        descEl.textContent = '';
                    }

                    var updateText = data.updated ? 'Data updated: ' + data.updated : '';
                    if (data._fromCache) updateText += ' (cached)';
                    updatedEl.textContent = updateText;
                    document.getElementById('resultExplain').style.display = 'none';
                    document.getElementById('resultExplainBtn').textContent = 'Explain';
                    explorerState.signalItems = UI.buildSignalItems(data, explorerState.datasetCode || data.datasetCode);
                    renderSignalFeed();
                    if (explorerState.datasetCode) {
                        updateExplorerUrlState();
                    }
                }
            } finally {
                loading.classList.remove('active');
            }
        }

        // ── Result Actions ───────────────────────────────────
        document.getElementById('resultTableToggle').addEventListener('click', function () {
            var tableEl = document.getElementById('resultTable');
            if (tableEl.style.display === 'none') {
                tableEl.style.display = 'block';
                tableEl.innerHTML = UI.dataTableHTML(explorerState.chartData);
                this.textContent = 'Chart';
            } else {
                tableEl.style.display = 'none';
                this.textContent = 'Table';
            }
        });

        document.getElementById('resultCsvBtn').addEventListener('click', function () {
            if (explorerState.chartData) UI.downloadCSV(explorerState.chartData, 'eurostat_explorer');
            else UI.toast('No data loaded yet.', 'warning');
        });

        document.getElementById('resultPngBtn').addEventListener('click', function () {
            if (explorerState.chartInstance) UI.downloadPNG(explorerState.chartInstance, 'eurostat_chart');
            else UI.toast('No chart rendered yet.', 'warning');
        });

        document.getElementById('resultCardBtn').addEventListener('click', function () {
            if (explorerState.chartInstance) {
                var title = explorerState.datasetCode ?
                    (DATASETS[explorerState.datasetCode]?.name || explorerState.datasetCode) :
                    'Eurostat Data';
                UI.cardGenerator.showModal(explorerState.chartInstance, title);
            } else {
                UI.toast('No chart rendered yet.', 'warning');
            }
        });

        document.getElementById('resultShareBtn').addEventListener('click', function () {
            if (explorerState.datasetCode) {
                UI.copyShareUrl({
                    dataset: explorerState.datasetCode,
                    geo: explorerState.geo,
                    type: explorerState.chartType,
                    events: explorerState.timelinePacks,
                    majorOnly: explorerState.majorEventsOnly,
                });
                return;
            }
            if (explorerState.lastUrl) UI.copyShareUrl(explorerState.lastUrl);
        });

        document.getElementById('resultExplainBtn').addEventListener('click', function () {
            if (!explorerState.chartData) {
                UI.toast('No data loaded yet.', 'warning');
                return;
            }
            var explainEl = document.getElementById('resultExplain');
            if (explainEl.style.display === 'none') {
                explainEl.textContent = UI.buildChartExplanation(
                    explorerState.chartData,
                    explorerState.datasetCode || explorerState.chartData.datasetCode,
                    { geo: explorerState.geo }
                );
                explainEl.style.display = 'block';
                this.textContent = 'Hide Explain';
            } else {
                explainEl.style.display = 'none';
                this.textContent = 'Explain';
            }
        });

        document.getElementById('resultPinBtn').addEventListener('click', function () {
            if (!explorerState.datasetCode) {
                UI.toast('Pin works with dataset-based explorer views.', 'warning');
                return;
            }
            var state = loadDashboardState();
            var id = explorerState.datasetCode + '|' + explorerState.geo.join(',') + '|' + explorerState.chartType + '|' + explorerState.timelinePacks.join(',');
            for (var i = 0; i < state.pinned.length; i++) {
                if (state.pinned[i].id === id) {
                    UI.toast('This view is already pinned.', 'info');
                    return;
                }
            }
            state.pinned.unshift({
                id: id,
                dataset: explorerState.datasetCode,
                geo: explorerState.geo.slice(),
                type: explorerState.chartType,
                events: explorerState.timelinePacks.slice(),
                majorOnly: explorerState.majorEventsOnly,
            });
            saveDashboardState(state);
            renderMyDashboard();
            UI.toast('Pinned to My Dashboard.', 'success');
        });

        myDashboardList.addEventListener('click', function (e) {
            var loadBtn = e.target.closest('.dashboard-load');
            var removeBtn = e.target.closest('.dashboard-remove');
            var defaultBtn = e.target.closest('.dashboard-default');
            if (!loadBtn && !removeBtn && !defaultBtn) return;
            var state = loadDashboardState();
            var id = (loadBtn || removeBtn || defaultBtn).dataset.id;
            var item = state.pinned.find(function (entry) { return entry.id === id; });
            if (!item) return;

            if (loadBtn) {
                applyPinnedView(item);
                return;
            }
            if (removeBtn) {
                state.pinned = state.pinned.filter(function (entry) { return entry.id !== id; });
                if (state.defaultViewId === id) state.defaultViewId = null;
                saveDashboardState(state);
                renderMyDashboard();
                return;
            }
            if (defaultBtn) {
                state.defaultViewId = id;
                saveDashboardState(state);
                renderMyDashboard();
                UI.toast('Default landing view updated.', 'success');
            }
        });

        document.getElementById('dashboardExportBtn').addEventListener('click', function () {
            var state = loadDashboardState();
            var blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            var a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'eurostat_my_dashboard.json';
            a.click();
            URL.revokeObjectURL(a.href);
        });

        document.getElementById('dashboardImportBtn').addEventListener('click', function () {
            document.getElementById('dashboardImportInput').click();
        });

        document.getElementById('dashboardImportInput').addEventListener('change', function () {
            if (!this.files || !this.files.length) return;
            var file = this.files[0];
            var reader = new FileReader();
            reader.onload = function () {
                try {
                    var imported = JSON.parse(String(reader.result || '{}'));
                    if (!imported || !Array.isArray(imported.pinned)) throw new Error('Invalid dashboard file.');
                    saveDashboardState({
                        pinned: imported.pinned,
                        defaultViewId: imported.defaultViewId || null,
                    });
                    renderMyDashboard();
                    UI.toast('Dashboard imported.', 'success');
                } catch (err) {
                    UI.toast(err.message || 'Failed to import dashboard.', 'error');
                }
            };
            reader.readAsText(file);
            this.value = '';
        });

        // ── Dataset Catalog ──────────────────────────────────
        (function renderCatalog() {
            var groups = getDatasetsByCategory();
            var catalogEl = document.getElementById('datasetCatalog');
            var html = '';
            var cats = Object.keys(groups).sort();
            for (var ci = 0; ci < cats.length; ci++) {
                var cat = cats[ci];
                var datasets = groups[cat];
                html += '<div class="dataset-codes-section mb-3">' +
                    '<button class="dataset-codes-toggle" aria-expanded="false">' +
                        '<span>' + UI._esc(cat) + ' <span class="dataset-codes-count">(' + datasets.length + ')</span></span>' +
                        '<span class="toggle-icon">&#9660;</span>' +
                    '</button>' +
                    '<div class="dataset-codes-list">';
                for (var di = 0; di < datasets.length; di++) {
                    var d = datasets[di];
                    html += '<div class="code-item" data-code="' + d.code + '" style="cursor:pointer;" title="Click to load in Explorer">' +
                        '<code>' + d.code + '</code>' +
                        '<span class="code-desc">' + UI._esc(d.name) + '</span>' +
                    '</div>';
                }
                html += '</div></div>';
            }
            catalogEl.innerHTML = html;

            // Toggle expand/collapse
            catalogEl.addEventListener('click', function (e) {
                var toggle = e.target.closest('.dataset-codes-toggle');
                if (toggle) {
                    var expanded = toggle.getAttribute('aria-expanded') === 'true';
                    toggle.setAttribute('aria-expanded', !expanded);
                    toggle.nextElementSibling.classList.toggle('expanded');
                    return;
                }
                // Click on a dataset code to load it
                var codeItem = e.target.closest('.code-item');
                if (codeItem && codeItem.dataset.code) {
                    selectDataset(codeItem.dataset.code);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
        })();

        // ── Handle share URL on page load ────────────────────
        (function handleShareUrl() {
            var params = new URLSearchParams(window.location.search);
            var sharedDataset = params.get('dataset');
            var sharedGeo = parseGeoParam(params.get('geo'));
            var sharedType = params.get('type');
            var sharedEvents = parseListParam(params.get('events'));
            var majorParam = params.get('major');

            if (sharedType && CONFIG.chartTypes.indexOf(sharedType) !== -1) {
                explorerState.chartType = sharedType;
                document.getElementById('chartTypeSelect').value = sharedType;
            }
            if (sharedEvents.length) {
                explorerState.timelinePacks = sharedEvents;
            }
            if (majorParam === '0') {
                explorerState.majorEventsOnly = false;
            }
            renderEventPackControls();

            if (sharedDataset) {
                if (sharedGeo.length) {
                    explorerState.geo = sharedGeo;
                    syncCountryPickerFromState();
                    var customBtn = document.querySelector('.btn-preset[data-preset="custom"]');
                    if (customBtn) {
                        setActivePreset(customBtn);
                        customPicker.style.display = 'flex';
                    }
                }
                selectDataset(sharedDataset);
                var sharedMeta = DATASETS[sharedDataset];
                var sharedFilters = sharedMeta ? sharedMeta.defaultFilters : {};
                var shareUrl = buildEurostatUrl(sharedDataset, explorerState.geo, sharedFilters);
                doVisualize(shareUrl, explorerState.chartType);
                return;
            }

            var sharedUrl = params.get('url');
            if (sharedUrl) {
                document.getElementById('rawUrlInput').value = sharedUrl;
                doVisualize(sharedUrl, explorerState.chartType);
                return;
            }

            var dashboardState = loadDashboardState();
            if (dashboardState.defaultViewId) {
                var defaultItem = dashboardState.pinned.find(function (entry) {
                    return entry.id === dashboardState.defaultViewId;
                });
                if (defaultItem) {
                    applyPinnedView(defaultItem);
                }
            }
        })();

        renderEventPackControls();
        renderSignalFeed();
        renderMyDashboard();

        try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch(e) {}
        try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch(e) {}
    </script>
</body>
</html>
