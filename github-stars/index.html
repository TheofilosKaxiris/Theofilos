<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Top Starred GitHub Repositories</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="css/styles.css" />
	<link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="../favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="../favicon/favicon-16x16.png">
	<link rel="manifest" href="../favicon/site.webmanifest">
	<link rel="shortcut icon" href="../favicon/favicon.ico">
	<style>
		/* Minimal custom tweaks */
		body {
			background: #0d1117;
			color: #c9d1d9;
		}

		a {
			text-decoration: none;
		}

		.repo-desc {
			max-width: 420px;
			font-size: .875rem;
			color: #8b949e;
		}

		.truncate-2 {
			display: -webkit-box;
			-webkit-line-clamp: 2;
			line-clamp: 2;
			-webkit-box-orient: vertical;
			overflow: hidden;
		}

		/* Constrain Repository cell */
		.repo-meta {
			min-width: 0;
		}

		.repo-name {
			display: block;
			max-width: 420px;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}

		@media (max-width: 576px) {
			.repo-name {
				max-width: 180px;
			}
		}

		.table thead th {
			position: sticky;
			top: 0;
			background: #161b22;
			z-index: 1;
		}

		.table-dark {
			--bs-table-bg: #161b22;
		}

		.owner-avatar {
			width: 32px;
			height: 32px;
			border-radius: 50%;
			object-fit: cover;
		}

		footer {
			font-size: .75rem;
			color: #6e7681;
		}

		.spinner-border {
			width: 1.75rem;
			height: 1.75rem;
		}
	</style>
</head>

<body>
	<nav class="navbar navbar-dark bg-dark mb-4">
		<div class="container-fluid">
			<span class="navbar-brand mb-0 h1">GitHub Top Stars</span>
		</div>
	</nav>
	<div class="container mb-4">
		<div class="row g-3 align-items-end mb-3">
			<div class="col-12 col-md-3">
				<label for="desiredTotal" class="form-label">Desired total (>1000 via segmentation)</label>
				<input type="number" id="desiredTotal" class="form-control" value="1500" min="1" max="10000" />
			</div>
			<div class="col-12 col-md-3">
				<label for="perPage" class="form-label">Per page</label>
				<input type="number" id="perPage" class="form-control" value="100" min="1" max="100" />
			</div>
			<div class="col-12 col-md-3 d-grid">
				<button id="loadSegmentedBtn" class="btn btn-outline-primary">Load Segmented</button>
			</div>
			<div class="col-12 col-md-3 d-grid">
				<button id="stopBtn" class="btn btn-outline-danger">Stop</button>
			</div>
		</div>
	</div>

	<main class="container mb-5">
		<div class="row g-3 align-items-end mb-3">
			<div class="col-12 col-md-3">
				<label for="limit" class="form-label">Number of repositories (max 1000)</label>
				<input type="number" id="limit" class="form-control" value="50" min="1" max="1000" />
			</div>
			<div class="col-12 col-md-3">
				<label for="language" class="form-label">Language (optional)</label>
				<input type="text" id="language" class="form-control" placeholder="e.g. JavaScript" />
			</div>
			<div class="col-12 col-md-4">
				<label for="token" class="form-label">GitHub Token (optional)</label>
				<input type="password" id="token" class="form-control" placeholder="ghp_..." autocomplete="off" />
			</div>
			<div class="col-12 col-md-2 d-grid">
				<button id="fetchBtn" class="btn btn-primary">Fetch</button>
			</div>
		</div>



		<div class="d-flex justify-content-between align-items-center mb-2">
			<div id="status" class="small text-secondary">Ready.</div>
		</div>

		<div class="table-responsive" style="max-height:70vh;">
			<table class="table table-dark table-hover table-sm align-middle" id="reposTable">
				<thead>
					<tr>
						<th scope="col">#</th>
						<th scope="col">Repository</th>
						<th scope="col">Stars</th>
						<th scope="col">Forks</th>
						<th scope="col">Language</th>
						<th scope="col" style="min-width:220px;">Description</th>
					</tr>
				</thead>
				<tbody>
					<!-- Rows injected dynamically -->
				</tbody>
			</table>
		</div>
	</main>

	<footer class="container text-center">
		<p class="mb-1">Data courtesy of GitHub Search API. Up to the first 1000 results per query.</p>
		<p class="mb-0">Provide a token for higher rate limits.</p>
	</footer>

	<script src="js/main.js"></script>
	<script>
		// UI integration script
		const fetchBtn = document.getElementById('fetchBtn');
		const statusEl = document.getElementById('status');
		const limitInput = document.getElementById('limit');
		const langInput = document.getElementById('language');
		const tokenInput = document.getElementById('token');
		const desiredTotalInput = document.getElementById('desiredTotal');
		const perPageInput = document.getElementById('perPage');
		const loadSegmentedBtn = document.getElementById('loadSegmentedBtn');
		const stopBtn = document.getElementById('stopBtn');
		const tableBody = document.querySelector('#reposTable tbody');

		function setStatus(msg, type = 'secondary') {
			statusEl.textContent = msg;
			statusEl.className = 'small text-' + type;
		}

		function buildQueryLimit(limit) {
			let n = parseInt(limit, 10);
			if (isNaN(n)) n = 50; else n = Math.min(1000, Math.max(1, n));
			console.log(n);
			return n;
		}

		function applyLanguageFilter(repos, language) {
			if (!language) return repos;
			const lower = language.toLowerCase();
			return repos.filter(r => (r.language || '').toLowerCase() === lower);
		}

		function renderRows(repos) {
			tableBody.innerHTML = '';
			const frag = document.createDocumentFragment();
			repos.forEach((repo, idx) => {
				const tr = document.createElement('tr');
				tr.innerHTML = `
					<th scope="row">${idx + 1}</th>
					<td>
						<div class="d-flex align-items-center gap-2">
							<img class="owner-avatar" src="${repo.owner.avatar_url}" alt="${repo.owner.login}">
							<div class="d-flex flex-column repo-meta">
								<a href="${repo.html_url}" target="_blank" rel="noopener" class="fw-semibold text-decoration-none repo-name">${repo.full_name}</a>
								<span class="badge bg-secondary">${repo.owner.login}</span>
							</div>
						</div>
					</td>
					<td><span class="text-warning">${repo.stargazers_count.toLocaleString()}</span></td>
					<td>${repo.forks_count.toLocaleString()}</td>
					<td>${repo.language || ''}</td>
					<td><div class="repo-desc truncate-2" title="${repo.description || ''}">${repo.description || ''}</div></td>
				`;
				frag.appendChild(tr);
			});
			tableBody.appendChild(frag);
		}

		async function fetchAndRender() {
			const limit = buildQueryLimit(limitInput.value);
			const language = langInput.value.trim();
			const token = tokenInput.value.trim() || undefined;
			setStatus('Loading…', 'info');
			tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4"><div class="spinner-border text-light" role="status"></div></td></tr>`;
			try {
				// Use paged API to fetch up to 'limit' items (cap 1000)
				const perPage = Math.min(100, limit);
				let repos = await getMostStarredReposPaged({ total: limit, perPage, token });
				repos = applyLanguageFilter(repos, language);
				renderRows(repos);
				setStatus(`Loaded ${repos.length} repos (limit ${limit}${language ? ', filtered by ' + language : ''}).`, 'success');
			} catch (err) {
				console.error(err);
				setStatus(err.message, 'danger');
				tableBody.innerHTML = `<tr><td colspan="6" class="text-danger">${err.message}</td></tr>`;
			}
		}

		// Segmented loader for >1000
		let currentController = null;
		function resetTable() { tableBody.innerHTML = ''; }
		async function loadSegmented() {
			const total = Math.max(1, Math.min(10000, parseInt(desiredTotalInput.value, 10) || 1500));
			const perPage = Math.max(1, Math.min(100, parseInt(perPageInput.value, 10) || 100));
			const language = langInput.value.trim();
			const token = tokenInput.value.trim() || undefined;

			currentController?.abort();
			currentController = new AbortController();
			resetTable();
			setStatus('Loading segmented…', 'info');

			try {
				const onPage = info => {
					if (info.window && Array.isArray(info.window.stars)) {
						const [min, max] = info.window.stars;
						setStatus(`Stars ${min}..${max} page ${info.page} — ${info.totalReceived}/${total}`, 'info');
					} else {
						setStatus(`Loading page ${info.page} — ${info.totalReceived}/${total}`, 'info');
					}
				};
				const baseQuery = language ? `language:${language} ` : '';
				const repos = await getMostStarredReposSegmented({ total, perPage, token, signal: currentController.signal, onPage, baseQuery });
				const filtered = applyLanguageFilter(repos, language);
				renderRows(filtered);
				setStatus(`Completed: ${filtered.length} repos (desired ${total}${language ? ', filtered by ' + language : ''}).`, 'success');
			} catch (err) {
				if (err.name === 'AbortError') {
					setStatus('Stopped.', 'warning');
					return;
				}
				console.error(err);
				setStatus(err.message, 'danger');
			}
		}
		fetchBtn.addEventListener('click', () => fetchAndRender());
		loadSegmentedBtn.addEventListener('click', loadSegmented);
		stopBtn.addEventListener('click', () => currentController?.abort());
		// Auto-load on first visit
		fetchAndRender();
	</script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
		crossorigin="anonymous"></script>
</body>

</html>